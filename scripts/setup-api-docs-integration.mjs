#!/usr/bin/env node

/**
 * Setup API Docs Integration
 * 
 * Updates all package sidebar configurations to link to generated API docs
 */

import { readFileSync, writeFileSync } from 'fs'
import { join, resolve } from 'path'

const ROOT_DIR = resolve(process.cwd())
const DOCS_APP_DIR = join(ROOT_DIR, 'apps/docs')

const PACKAGES = [
  'cli',
  'config',
  'data',
  'fs',
  'validation',
  'create-cli'
]

function updateSidebar(pkg) {
  const sidebarPath = join(DOCS_APP_DIR, `sidebars-${pkg}.ts`)
  
  try {
    let content = readFileSync(sidebarPath, 'utf-8')
    
    // Check if API Reference link already exists
    if (content.includes('API Reference')) {
      console.log(`✅ ${pkg}: Already has API Reference link`)
      return
    }
    
    // Add API Reference link after the last item in the sidebar array
    const lastBracketIndex = content.lastIndexOf(']')
    const lastItemEnd = content.lastIndexOf('},', lastBracketIndex)
    
    if (lastItemEnd === -1) {
      console.log(`⚠️  ${pkg}: Could not find insertion point`)
      return
    }
    
    const insertion = `,
    {
      type: 'link',
      label: 'API Reference',
      href: '/packages/${pkg}/api',
    }`
    
    content = content.slice(0, lastItemEnd + 2) + insertion + content.slice(lastItemEnd + 2)
    
    writeFileSync(sidebarPath, content)
    console.log(`✅ ${pkg}: Added API Reference link`)
    
  } catch (error) {
    console.log(`❌ ${pkg}: Error updating sidebar - ${error.message}`)
  }
}

// Create API sidebar files for each package
function createApiSidebar(pkg) {
  const sidebarPath = join(DOCS_APP_DIR, `sidebars-${pkg}-api.ts`)
  
  const content = `import type { SidebarsConfig } from '@docusaurus/plugin-content-docs'

const sidebars: SidebarsConfig = {
  apiSidebar: [
    {
      type: 'autogenerated',
      dirName: '.',
    },
  ],
}

export default sidebars
`
  
  writeFileSync(sidebarPath, content)
  console.log(`✅ Created API sidebar for ${pkg}`)
}

// Main execution
console.log('Setting up API documentation integration...\n')

console.log('Creating API sidebar files...')
PACKAGES.forEach(createApiSidebar)

console.log('\nUpdating package sidebars...')
PACKAGES.forEach(updateSidebar)

console.log('\n✅ API documentation integration setup complete!')
console.log('\nNext steps:')
console.log('1. Update docusaurus.config.ts to add API doc instances for each package')
console.log('2. Run "pnpm docs:api" to generate API documentation')
console.log('3. Run "pnpm docs:dev" to test the integration')