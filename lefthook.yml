# Lefthook configuration for high-performance git hooks
# https://github.com/evilmartians/lefthook

# Skip hooks with SKIP_HOOKS=1 or LEFTHOOK=0
skip_output:
  - meta

# Show execution time for performance monitoring
output:
  - summary
  - success
  - failure
  - execution
  - execution_out
  - execution_info

colors: true

pre-commit:
  parallel: true
  commands:
    # 1. Format code (fastest, runs first)
    prettier:
      priority: 1
      glob: "**/*.{ts,tsx,js,jsx,json,md}"
      run: pnpm prettier --write {staged_files} --cache --cache-location .turbo/.prettiercache
      stage_fixed: true
      
    # 2. Validate documentation structure
    docs-validate:
      priority: 2
      glob: "{docs,packages/**/docs}/**/*.md"
      run: |
        for file in {staged_files}; do
          pnpm docs:validate "$file"
        done
        
    # 3. Lint TypeScript/JavaScript with oxlint (50-100x faster than ESLint)
    oxlint:
      priority: 3
      glob: "packages/**/*.{ts,tsx,js,jsx}"
      run: pnpm oxlint {staged_files} --fix
      stage_fixed: true
      
    # 4. Type check (simplified)
    typecheck:
      priority: 4
      glob: "packages/**/*.{ts,tsx}"
      run: pnpm types --filter="./packages/*" -- --incremental

    # 5. Check for secrets (simplified)
    secrets:
      priority: 5
      run: git diff --cached --name-only | xargs grep -l -E -i "(api[_-]?key|secret|token|password)" 2>/dev/null && echo "‚ö†Ô∏è Potential secrets detected" || true

    # 6. Check file sizes (simplified)
    filesize:
      priority: 6
      run: 'find {staged_files} -size +1M 2>/dev/null | head -5 | xargs -I {} echo "‚ö†Ô∏è Large file: {}" || true'

prepare-commit-msg:
  commands:
    changeset-reminder:
      run: |
        if git diff --cached --name-only | grep -q "^packages/"; then
          echo "üìù Reminder: If this change should be released, don't forget to add a changeset!"
          echo "   Run: pnpm changeset:add"
        fi
      skip:
        - merge
        - rebase

commit-msg:
  commands:
    commitlint:
      run: |
        first_line=$(head -n1 "$1")
        if ! echo "$first_line" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,50}$'; then
          echo "‚ùå Commit message must follow conventional format:"
          echo "   type(scope?): description"
          echo "   Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
          echo "   Example: feat(web-ui): add dark mode support"
          exit 1
        fi

pre-push:
  parallel: true
  commands:
    # Validate lockfile is up to date (simplified)
    lockfile-check:
      priority: 1
      run: |
        echo "üîí Checking if pnpm-lock.yaml is up to date..."
        pnpm install --lockfile-only --frozen-lockfile || {
          echo "‚ùå pnpm-lock.yaml is out of date! Run 'pnpm install' and commit the updated lockfile"
          exit 1
        }
        echo "‚úÖ Lockfile is up to date"

# Personal overrides (not committed)
# Create .lefthook-local.yml to customize