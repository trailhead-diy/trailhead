# Lefthook configuration for high-performance git hooks
# https://github.com/evilmartians/lefthook

# Skip hooks with SKIP_HOOKS=1 or LEFTHOOK=0
skip_output:
  - meta

# Show execution time for performance monitoring
output:
  - summary
  - success
  - failure
  - execution
  - execution_out
  - execution_info

colors: true

pre-commit:
  parallel: false
  commands:
    # 1. Format code (fastest, auto-fix)
    prettier:
      priority: 1
      glob: "**/*.{ts,tsx,js,jsx,json,md}"
      run: pnpm prettier --write {staged_files} --cache --cache-location .turbo/.prettiercache
      stage_fixed: true
      
    # 2. Lint TypeScript/JavaScript with oxlint (critical errors)
    oxlint:
      priority: 2
      glob: "packages/**/*.{ts,tsx,js,jsx}"
      run: pnpm oxlint {staged_files} --fix
      stage_fixed: true
      
    # 3. Type check (logic errors)
    typecheck:
      priority: 3
      glob: "packages/**/*.{ts,tsx}"
      run: pnpm types --filter="./packages/*" -- --incremental

    # 4. Validate documentation structure (if docs changed)
    docs-validate:
      priority: 4
      glob: "{docs,packages/**/docs}/**/*.md"
      run: |
        for file in {staged_files}; do
          pnpm docs:validate "$file"
        done
        
    # 5. Check for secrets (security)
    secrets:
      priority: 5
      exclude: '(pnpm-lock\.yaml|package-lock\.json|yarn\.lock)$'
      run: git diff --cached --name-only | xargs grep -l -E -i "(api[_-]?key|secret|token|password)" 2>/dev/null && echo "‚ö†Ô∏è Potential secrets detected" || true

    # 6. Check file sizes (size validation)
    filesize:
      priority: 6
      run: 'find {staged_files} -size +1M 2>/dev/null | head -5 | xargs -I {} echo "‚ö†Ô∏è Large file: {}" || true'
      
    # 7. Smart test execution (comprehensive validation)
    smart-tests:
      priority: 7
      run: ./scripts/smart-test-runner.sh

prepare-commit-msg:
  commands:
    changeset-reminder:
      run: |
        if git diff --cached --name-only | grep -q "^packages/"; then
          echo "üìù Reminder: If this change should be released, don't forget to add a changeset!"
          echo "   Run: pnpm changeset:add"
        fi
      skip:
        - merge
        - rebase

commit-msg:
  commands:
    commitlint:
      run: 'first_line=$(head -n1 {1}); if ! echo "$first_line" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+$"; then echo "‚ùå Commit message must follow conventional format:"; echo "   type(scope?): description"; echo "   Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"; echo "   Example: feat(web-ui): add dark mode support"; exit 1; fi'

pre-push:
  parallel: true
  commands:
    # Validate lockfile is up to date (simplified)
    lockfile-check:
      priority: 1
      run: |
        echo "üîí Checking if pnpm-lock.yaml is up to date..."
        pnpm install --lockfile-only --frozen-lockfile || {
          echo "‚ùå pnpm-lock.yaml is out of date! Run 'pnpm install' and commit the updated lockfile"
          exit 1
        }
        echo "‚úÖ Lockfile is up to date"
    
    # Check branch sync status (warning only)
    branch-sync-check:
      priority: 2
      run: |
        echo "üåø Checking branch sync status..."
        cd packages/cli && pnpm build > /dev/null 2>&1
        node --input-type=module -e "
          import { checkBranchSync, formatSyncStatus } from './dist/git/index.js';
          (async () => {
            const result = await checkBranchSync('origin/main', { fetch: true });
            if (!result.success) {
              console.log('‚ÑπÔ∏è Could not check branch sync:', result.error.message);
              process.exit(0);
            }
            const status = result.value;
            if (!status.isUpToDate) {
              console.log('‚ö†Ô∏è ' + formatSyncStatus(status));
              if (status.behind > 10) {
                console.log('‚ùå Branch is significantly behind. Please sync before pushing.');
                process.exit(1);
              }
            } else {
              console.log('‚úÖ Branch is up to date with origin/main');
            }
          })().catch(err => {
            console.log('‚ÑπÔ∏è Branch sync check failed:', err.message);
            process.exit(0);
          });
        "

# Personal overrides (not committed)
# Create .lefthook-local.yml to customize