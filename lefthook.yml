# Lefthook configuration for high-performance git hooks
# https://github.com/evilmartians/lefthook

# Skip hooks with SKIP_HOOKS=1 or LEFTHOOK=0
skip_output:
  - meta
  - execution_info

# Only show essential output: summary and failures
output:
  - summary
  - failure

colors: true

pre-commit:
  parallel: true
  commands:
    # 1. Format code (fastest, auto-fix)
    prettier:
      priority: 1
      glob: "**/*.{ts,tsx,js,jsx,json,md}"
      run: pnpm prettier --write {staged_files} --cache --cache-location .turbo/.prettiercache
      stage_fixed: true

    # 2. Lint TypeScript/JavaScript with oxlint (critical errors)
    oxlint:
      priority: 2
      glob: "packages/**/*.{ts,tsx,js,jsx}"
      run: pnpm oxlint {staged_files} --fix
      stage_fixed: true

    # 3. Type check (logic errors)
    typecheck:
      priority: 3
      glob: "**/*.{ts,tsx}"
      run: pnpm types --filter="./packages/*" -- --incremental

    # 4. JSDoc validation (documentation coverage)
    jsdoc:
      priority: 4
      glob: "packages/*/src/**/*.{ts,tsx}"
      run: |
        echo "üìö Validating JSDoc coverage..."
        pnpm typedoc --emit none || {
          echo "‚ö†Ô∏è  TypeDoc validation warnings detected"
          echo "üí° Add JSDoc to public APIs (functions, interfaces, types)"
          echo "   See: typedoc.json for validation rules"
          echo "   Note: This is a warning, not blocking commit"
          exit 0
        }

prepare-commit-msg:
  commands:
    changeset-reminder:
      run: |
        if git diff --cached --name-only | grep -q "^packages/"; then
          echo "üìù Reminder: If this change should be released, don't forget to add a changeset!"
          echo "   Run: pnpm changeset:add"
        fi
      skip:
        - merge
        - rebase

commit-msg:
  commands:
    commitlint:
      run: 'first_line=$(head -n1 {1}); if ! echo "$first_line" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+$"; then echo "‚ùå Commit message must follow conventional format:"; echo "   type(scope?): description"; echo "   Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"; echo "   Example: feat(cli): add new command"; exit 1; fi'

pre-push:
  commands:
    # Generate API documentation
    generate-docs:
      priority: 1
      run: |
        # Check if any source files changed
        if ! git diff --name-only origin/main...HEAD 2>/dev/null | grep -qE "^packages/.*/src/.*\.ts$"; then
          exit 0
        fi

        echo "üìö Source files changed, updating API documentation..."

        # Build packages first (required for TypeDoc)
        if ! pnpm turbo run build --filter="./packages/*" --force > /dev/null 2>&1; then
          echo "‚ö†Ô∏è  Build failed, skipping docs generation"
          exit 0
        fi

        # Generate docs (includes formatting)
        pnpm docs:api || {
          echo "‚ö†Ô∏è  TypeDoc generation had warnings (non-blocking)"
          exit 0
        }

        # Check if docs changed and stage them
        if ! git diff --quiet docs/; then
          git add docs/
          echo "‚úÖ API documentation updated and staged"
          echo "   Docs will be included in this push"
        else
          echo "‚úÖ API documentation unchanged"
        fi

    # Run tests and validate before push
    validate-push:
      priority: 2
      run: |
        echo "üöÄ Running pre-push validation..."
        echo "‚ö° Running tests and type checks..."

        # Run tests and types in parallel via Turbo
        pnpm turbo run test types --filter="./packages/*" || {
          echo ""
          echo "‚ùå Pre-push validation failed!"
          echo ""
          echo "üí° Fix issues with:"
          echo "   pnpm test         # Run tests"
          echo "   pnpm types        # Type check"
          echo ""
          echo "üö® To bypass (emergencies only):"
          echo "   git push --no-verify"
          echo ""
          exit 1
        }

    # Validate lockfile is up to date
    lockfile-check:
      priority: 3
      run: |
        pnpm install --lockfile-only --frozen-lockfile > /dev/null 2>&1 || {
          echo "‚ùå pnpm-lock.yaml is out of date! Run 'pnpm install' and commit the updated lockfile"
          exit 1
        }

# ============================================================
# Personal Overrides (not committed)
# ============================================================
# Create .lefthook-local.yml to customize for your workflow
#
# Examples:
#
# Skip specific hooks during development:
# pre-commit:
#   exclude_tags:
#     - typecheck    # Skip type checking for faster commits
#
# Skip all hooks temporarily:
# skip: true
#
# Skip specific commands:
# pre-commit:
#   commands:
#     prettier:
#       skip: true   # Skip if you have auto-format on save
#
# Skip hooks for specific file patterns:
# pre-commit:
#   commands:
#     oxlint:
#       exclude: "*.test.{ts,tsx}"
#
# Quick override via environment:
#   LEFTHOOK=0 git commit  # Skip all hooks
