import { describe, it, expect, beforeEach, vi } from 'vitest'
import { createTestContext } from '@esteban-url/cli/testing'
import { devCommand } from '../dev.js'

describe('dev command', () => {
  let testContext: ReturnType<typeof createTestContext>

  beforeEach(() => {
    testContext = createTestContext()
    // Mock interactive prompts to prevent hanging in tests
    vi.mock('@esteban-url/cli/prompts')
  })

  it('should start development server with default options', async () => {
    const result = await devCommand.action(
      {},
      testContext
    )

    expect(result.isOk()).toBe(true)
    expect(testContext.logs).toContain('Development server is running!')
    expect(testContext.logs.some(log => log.includes('http://localhost:3000'))).toBe(true)
  })

  it('should use custom port and host', async () => {
    const result = await devCommand.action(
      { port: 8080, host: '0.0.0.0' },
      testContext
    )

    expect(result.isOk()).toBe(true)
    expect(testContext.logs.some(log => log.includes('http://0.0.0.0:8080'))).toBe(true)
  })

  it('should reject invalid port numbers', async () => {
    const result = await devCommand.action(
      { port: 0 },
      testContext
    )

    expect(result.isErr()).toBe(true)
    expect(result.error.code).toBe('DEV_SERVER_FAILED')
  })

  it('should handle port availability check', async () => {
    const result = await devCommand.action(
      { port: 3000 },
      testContext
    )

    expect(result.isOk()).toBe(true)
    expect(testContext.logs).toContain('Development server is running!')
  })

  it('should support browser opening option', async () => {
    const result = await devCommand.action(
      { open: true },
      testContext
    )

    expect(result.isOk()).toBe(true)
    expect(testContext.logs).toContain('Opening browser...')
  })

  it('should handle server startup errors gracefully', async () => {
    const result = await devCommand.action(
      { port: -1 },
      testContext
    )

    expect(result.isErr()).toBe(true)
    expect(result.error.code).toBe('DEV_SERVER_FAILED')
    expect(result.error.suggestion).toBe('Check the port configuration and try again')
  })

  it('should log verbose output when requested', async () => {
    const result = await devCommand.action(
      { verbose: true, port: 4000 },
      testContext
    )

    expect(result.isOk()).toBe(true)
    expect(testContext.verbose).toBe(true)
    expect(testContext.logs.some(log => log.includes('Server configuration:'))).toBe(true)
  })
})