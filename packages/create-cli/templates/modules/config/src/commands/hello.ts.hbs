import { createCommand, type CommandContext } from '@trailhead/cli/command'
import { ok, type Result, type CoreError } from '@trailhead/core'
import { createSpinner } from '@trailhead/cli/utils'
import { fs } from '@trailhead/fs'
import { resolve } from 'path'
import { configSchema, type Config } from '../lib/config-schema.js'

/**
 * Hello command - demonstrates using configuration
 *
 * Reads the config.json file and uses the theme.color setting
 * to print a colored "Hello, World!" message.
 *
 * This shows:
 * - Reading config with @trailhead/fs
 * - Using config values in commands
 * - Graceful fallback when config doesn't exist
 * - Using spinner for progress indication
 * - Using ANSI color codes for output
 */
export const helloCommand = createCommand({
  name: 'hello',
  description: 'Print a hello message using the configured theme color',
  action: async (_options, context): Promise<Result<void, CoreError>> => {
    const configPath = resolve('config.json')

    // Show spinner while loading config
    const spinner = createSpinner('Loading configuration...')
    spinner.start()

    // Add a small delay to show the spinner (demo purposes)
    await new Promise((resolve) => setTimeout(resolve, 800))

    // Try to read config file
    const configResult = await fs.readJson<unknown>(configPath)

    // Use configured color or fall back to default
    let color: Config['theme']['color'] = 'cyan'

    if (configResult.isOk()) {
      // Validate config with schema
      const validationResult = configSchema.safeParse(configResult.value)
      if (validationResult.success) {
        color = validationResult.data.theme.color
        spinner.success('Configuration loaded')
      } else {
        spinner.warning('Config invalid, using defaults')
        context.logger.warning('Config file exists but is invalid, using default color')
      }
    } else {
      spinner.success('Using default configuration')
    }

    // Print hello message using ANSI color codes
    const coloredMessage = getColoredMessage('Hello, World!', color)
    context.logger.raw.log(coloredMessage)
    context.logger.info(`Theme color: ${color}`)

    return ok(undefined)
  },
})

/**
 * Get colored message using consola/ANSI color codes
 */
function getColoredMessage(text: string, color: Config['theme']['color']): string {
  const colors = {
    blue: '\x1b[34m',
    green: '\x1b[32m',
    red: '\x1b[31m',
    yellow: '\x1b[33m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m',
  }
  const reset = '\x1b[0m'
  return `${colors[color]}${text}${reset}`
}
