name: Tier 2 - Pre-Release Comprehensive Validation

on:
  push:
    tags: ['v*']                    # For releases
    branches: [main]                # For CLI changes on main
    paths: ['packages/cli/**', 'packages/create-trailhead-cli/**']  # CLI-specific changes
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      install_dependencies:
        description: 'Install dependencies in generated projects'
        required: false
        default: true
        type: boolean
      run_performance_tests:
        description: 'Run performance testing suite'
        required: false
        default: true
        type: boolean
  schedule:
    # Weekly comprehensive regression testing (Mondays 8 AM UTC)
    - cron: '0 8 * * 1'

permissions:
  contents: read
  security-events: write  # For security scanning
  actions: read

env:
  FORCE_COLOR: 3
  CI: true

jobs:
  # Enhanced change detection and trigger analysis
  detect-scope:
    name: Detect Validation Scope
    runs-on: ubuntu-latest
    outputs:
      cli-changes: ${{ steps.filter.outputs.cli }}
      web-ui-changes: ${{ steps.filter.outputs.web-ui }}
      is-tag: ${{ startsWith(github.ref, 'refs/tags/') }}
      is-release: ${{ github.event_name == 'release' }}
      is-scheduled: ${{ github.event_name == 'schedule' }}
      is-manual: ${{ github.event_name == 'workflow_dispatch' }}
      validation-tier: ${{ steps.determine-tier.outputs.tier }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cli:
              - 'packages/cli/**'
              - 'packages/create-trailhead-cli/**'
            web-ui:
              - 'packages/web-ui/**'
            workflows:
              - '.github/workflows/**'

      - name: Determine validation tier
        id: determine-tier
        run: |
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]] || [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tier=release" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "tier=regression" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.filter.outputs.cli }}" == "true" ]]; then
            echo "tier=cli-focused" >> $GITHUB_OUTPUT
          else
            echo "tier=standard" >> $GITHUB_OUTPUT
          fi

  # Cross-platform CLI testing with comprehensive matrix (2025 best practices)
  cli-cross-platform:
    name: CLI Matrix (${{ matrix.os }}, Node ${{ matrix.node }})
    runs-on: ${{ matrix.os }}
    needs: detect-scope
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: ['18', '20', '22']  # 2025 LTS versions
        include:
          # Test different package managers per OS
          - os: ubuntu-latest
            package-manager: pnpm
          - os: windows-latest
            package-manager: npm
          - os: macos-latest
            package-manager: pnpm
        exclude:
          # Optimize matrix for faster execution
          - os: windows-latest
            node: '18'
          - os: macos-latest
            node: '18'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ matrix.node }}

      - name: Cache TurboRepo (GitHub Actions)
        uses: actions/cache@v4
        with:
          path: |
            .turbo
            node_modules/.cache
            ~/.cache
          key: turbo-cross-platform-${{ runner.os }}-${{ matrix.node }}-${{ hashFiles('**/pnpm-lock.yaml', 'turbo.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}
          restore-keys: |
            turbo-cross-platform-${{ runner.os }}-${{ matrix.node }}-${{ hashFiles('**/pnpm-lock.yaml', 'turbo.json') }}-
            turbo-cross-platform-${{ runner.os }}-${{ matrix.node }}-
            turbo-cross-platform-${{ runner.os }}-

      - name: Build packages
        run: pnpm build

      - name: Run CLI tests
        run: pnpm --filter=@esteban-url/trailhead-cli test

      - name: Test CLI functionality
        shell: bash
        run: |
          cd packages/cli
          node dist/src/index.js --help
          echo "âœ… CLI works on ${{ matrix.os }} with Node ${{ matrix.node }}"

      - name: Test generator
        shell: bash
        run: |
          cd packages/create-trailhead-cli
          node dist/index.js generate test-${{ matrix.node }}-${{ matrix.package-manager }} \
            --template basic \
            --package-manager ${{ matrix.package-manager }} \
            --force
          
          cd test-${{ matrix.node }}-${{ matrix.package-manager }}
          npx tsc --noEmit
          echo "âœ… Generator works on ${{ matrix.os }}"

  # Enhanced security scanning (2025 standards)
  security-deep-scan:
    name: Security Deep Scan
    runs-on: ubuntu-latest
    needs: detect-scope
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm

      - name: Comprehensive dependency audit
        run: |
          echo "ðŸ” Running comprehensive security audit..."
          pnpm audit --audit-level=moderate || echo "::warning::Security vulnerabilities found"
          
          # Enhanced vulnerability scanning
          if command -v npm >/dev/null 2>&1; then
            npx better-npm-audit audit --level=moderate || echo "::warning::Enhanced audit found issues"
          fi

      - name: License compliance check
        run: |
          echo "ðŸ“„ Checking license compliance..."
          npx license-checker --summary --production \
            --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;Unlicense' \
            || echo "::warning::License compliance issues found"

      - name: Secret detection
        run: |
          echo "ðŸ” Running secret detection..."
          # Check commit messages for potential secrets
          if git log --oneline -n 50 | grep -iE "(password|secret|key|token|api_key|private_key)" | head -5; then
            echo "::warning::Potential secrets found in commit messages"
          fi
          
          # Check source code for hardcoded secrets
          if find . -name "*.ts" -o -name "*.js" -o -name "*.json" | \
             grep -v node_modules | grep -v ".git" | \
             xargs grep -l "password\|secret\|api_key\|private_key" 2>/dev/null | head -5; then
            echo "::warning::Potential secrets found in source code"
          fi

      - name: Supply chain security
        continue-on-error: true
        run: |
          echo "ðŸ”— Checking supply chain security..."
          # Check for suspicious packages
          npx @socketsecurity/cli audit || echo "::warning::Supply chain issues detected"

  # Performance testing and benchmarking
  performance-testing:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: detect-scope
    if: |
      github.event.inputs.run_performance_tests != 'false' && (
        needs.detect-scope.outputs.cli-changes == 'true' || 
        needs.detect-scope.outputs.is-tag == 'true' || 
        needs.detect-scope.outputs.is-scheduled == 'true'
      )
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm

      - name: Build packages
        run: pnpm build

      - name: CLI Performance Tests
        run: |
          echo "âš¡ Running CLI performance benchmarks..."
          cd packages/cli
          
          # Measure CLI startup time
          echo "Testing CLI startup performance..."
          START=$(date +%s%N)
          node dist/src/index.js --help >/dev/null 2>&1
          END=$(date +%s%N)
          STARTUP_TIME=$(( (END - START) / 1000000 ))
          echo "CLI startup time: ${STARTUP_TIME}ms"
          
          if [ $STARTUP_TIME -gt 500 ]; then
            echo "::warning::CLI startup time degraded (>${STARTUP_TIME}ms)"
          fi

      - name: Generator Performance Tests
        run: |
          echo "ðŸš€ Testing generator performance..."
          cd packages/create-trailhead-cli
          
          for template in basic advanced; do
            echo "Testing $template template..."
            START=$(date +%s)
            node dist/index.js generate perf-test-$template \
              --template $template \
              --package-manager pnpm \
              --force >/dev/null 2>&1
            END=$(date +%s)
            DURATION=$((END - START))
            echo "$template template generation: ${DURATION}s"
            
            if [ $DURATION -gt 20 ]; then
              echo "::warning::$template template performance degraded (${DURATION}s)"
            fi
          done

      - name: Build Performance Analysis
        run: |
          echo "ðŸ—ï¸ Analyzing build performance..."
          START=$(date +%s)
          pnpm build >/dev/null 2>&1
          END=$(date +%s)
          BUILD_TIME=$((END - START))
          echo "Full build time: ${BUILD_TIME}s"
          
          if [ $BUILD_TIME -gt 60 ]; then
            echo "::warning::Build performance degraded (${BUILD_TIME}s)"
          fi

  # Comprehensive E2E testing with matrix strategy
  comprehensive-e2e:
    name: E2E (${{ matrix.template }}, ${{ matrix.pm }})
    runs-on: ubuntu-latest
    needs: detect-scope
    if: |
      github.event.inputs.install_dependencies != 'false' && (
        needs.detect-scope.outputs.validation-tier == 'release' ||
        needs.detect-scope.outputs.validation-tier == 'regression' ||
        needs.detect-scope.outputs.is-manual == 'true'
      )
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        template: [basic, advanced, enterprise]
        pm: [pnpm, npm]
        exclude:
          # Optimize matrix for critical paths
          - template: advanced
            pm: npm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm

      - name: Build packages
        run: pnpm build

      - name: Run E2E test
        run: |
          cd packages/create-trailhead-cli
          
          echo "ðŸ§ª Testing ${{ matrix.template }} with ${{ matrix.pm }}"
          
          node dist/index.js generate e2e-${{ matrix.template }}-${{ matrix.pm }} \
            --template ${{ matrix.template }} \
            --package-manager ${{ matrix.pm }} \
            --docs --git --force
          
          cd e2e-${{ matrix.template }}-${{ matrix.pm }}
          
          # Install and test if enabled
          if [[ "${{ github.event.inputs.install_dependencies || 'true' }}" == "true" ]]; then
            echo "ðŸ“¦ Installing dependencies..."
            if [[ "${{ matrix.pm }}" == "pnpm" ]]; then
              pnpm install && pnpm build && pnpm test
            else
              npm install && npm run build && npm test
            fi
          fi
          
          npx tsc --noEmit
          echo "âœ… E2E passed for ${{ matrix.template }}"

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-${{ matrix.template }}-${{ matrix.pm }}
          path: packages/create-trailhead-cli/e2e-*
          retention-days: 3

  # Integration testing across monorepo packages
  integration-testing:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: detect-scope
    timeout-minutes: 12
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node-pnpm

      - name: Build all packages
        run: pnpm build

      - name: Test cross-package integration
        run: |
          echo "ðŸ”— Testing package interdependencies..."
          
          # Test web-ui can be imported
          cd packages/web-ui
          node -e "
            try {
              const { Button } = require('./dist/lib/button.js');
              console.log('âœ… Web UI components importable');
            } catch (e) {
              console.error('âŒ Web UI import failed:', e.message);
              process.exit(1);
            }
          "
          
          # Test generator creates valid projects
          cd ../create-trailhead-cli
          node dist/index.js generate integration-test \
            --template advanced --package-manager pnpm --force
          
          cd integration-test
          npx tsc --noEmit
          echo "âœ… Cross-package integration working"

  # Comprehensive validation summary with intelligent reporting
  validation-summary:
    name: Pre-Release Validation Summary
    runs-on: ubuntu-latest
    needs: [
      detect-scope,
      cli-cross-platform,
      security-deep-scan,
      performance-testing,
      comprehensive-e2e,
      integration-testing
    ]
    if: always()
    steps:
      - name: Analyze validation results
        run: |
          echo "ðŸ“Š Pre-Release Validation Analysis"
          echo "=================================="
          echo "Validation Tier: ${{ needs.detect-scope.outputs.validation-tier }}"
          echo "Trigger: ${{ github.event_name }}"
          echo ""
          
          # Check critical jobs
          CLI_STATUS="${{ needs.cli-cross-platform.result }}"
          SECURITY_STATUS="${{ needs.security-deep-scan.result }}"
          INTEGRATION_STATUS="${{ needs.integration-testing.result }}"
          
          echo "Critical Validations:"
          echo "  CLI Cross-Platform: $CLI_STATUS"
          echo "  Security Scan: $SECURITY_STATUS"
          echo "  Integration Tests: $INTEGRATION_STATUS"
          
          # Check optional jobs
          PERF_STATUS="${{ needs.performance-testing.result }}"
          E2E_STATUS="${{ needs.comprehensive-e2e.result }}"
          
          echo ""
          echo "Enhanced Validations:"
          echo "  Performance Tests: ${PERF_STATUS:-skipped}"
          echo "  E2E Tests: ${E2E_STATUS:-skipped}"
          
          # Determine release readiness
          RELEASE_READY=true
          if [[ "$CLI_STATUS" != "success" ]] || [[ "$SECURITY_STATUS" != "success" ]] || [[ "$INTEGRATION_STATUS" != "success" ]]; then
            RELEASE_READY=false
          fi
          
          echo ""
          if [[ "$RELEASE_READY" == "true" ]]; then
            echo "âœ… RELEASE VALIDATION: PASSED"
            echo "ðŸš€ Ready for production release"
            
            if [[ "$PERF_STATUS" != "success" ]] || [[ "$E2E_STATUS" != "success" ]]; then
              echo "âš ï¸ Optional validations failed - review recommended"
            fi
          else
            echo "âŒ RELEASE VALIDATION: FAILED"
            echo "ðŸ›‘ Critical issues detected - DO NOT RELEASE"
            exit 1
          fi

      - name: Generate comprehensive summary
        if: always()
        run: |
          echo "## ðŸš€ Tier 2 Pre-Release Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Tier:** \`${{ needs.detect-scope.outputs.validation-tier }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation Suite | Status | Priority |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| CLI Cross-Platform | ${{ needs.cli-cross-platform.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Deep Scan | ${{ needs.security-deep-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-testing.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ðŸ”´ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-testing.result == 'success' && 'âœ… Passed' || needs.performance-testing.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | ðŸŸ¡ Enhanced |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.comprehensive-e2e.result == 'success' && 'âœ… Passed' || needs.comprehensive-e2e.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | ðŸŸ¡ Enhanced |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Release decision
          if [[ "${{ needs.cli-cross-platform.result }}" == "success" ]] && [[ "${{ needs.security-deep-scan.result }}" == "success" ]] && [[ "${{ needs.integration-testing.result }}" == "success" ]]; then
            echo "### ðŸŽ‰ **Release Status: APPROVED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All critical validations passed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Ready for production release**" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ needs.performance-testing.result }}" != "success" ]] || [[ "${{ needs.comprehensive-e2e.result }}" != "success" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Note:** Some enhanced validations failed - review recommended before release" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ **Release Status: REJECTED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ›‘ **Critical validations failed**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Action Required:** Fix failing tests before release" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Validation completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY