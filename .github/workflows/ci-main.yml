name: Tier 1 - Main Branch CI

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - '.github/workflows/pre-release-testing.yml'  # Tier 2 changes don't need Tier 1
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Smart change detection for main branch
  detect-strategy:
    name: Detect CI Strategy
    runs-on: ubuntu-latest
    outputs:
      needs-tier-2: ${{ steps.filter.outputs.cli == 'true' || steps.filter.outputs.workflows == 'true' || steps.filter.outputs.critical == 'true' }}
      tier-1-only: ${{ steps.filter.outputs.cli == 'false' && steps.filter.outputs.critical == 'false' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cli:
              - 'packages/cli/**'
              - 'packages/create-trailhead-cli/**'
            workflows:
              - '.github/workflows/**'
            critical:
              - 'pnpm-lock.yaml'
              - 'turbo.json'
              - 'package.json'
            web-ui:
              - 'packages/web-ui/**'
            demos:
              - 'apps/demos/**'

  # Fast Tier 1 CI for all main branch changes
  tier-1-ci:
    name: Tier 1 Fast Validation
    needs: detect-strategy
    uses: ./.github/workflows/reusable-ci.yml
    with:
      os-matrix: '["ubuntu-latest"]'
      fast-mode: true
    secrets: inherit

  # Trigger Tier 2 for critical changes
  trigger-tier-2:
    name: Trigger Tier 2 Validation
    needs: [detect-strategy, tier-1-ci]
    if: needs.detect-strategy.outputs.needs-tier-2 == 'true' && needs.tier-1-ci.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger comprehensive validation
        run: |
          echo "ðŸš€ Critical changes detected - Tier 2 validation will run automatically"
          echo "Changes requiring comprehensive validation:"
          if [[ "${{ needs.detect-strategy.outputs.cli }}" == "true" ]]; then
            echo "  - CLI package changes"
          fi
          if [[ "${{ needs.detect-strategy.outputs.workflows }}" == "true" ]]; then
            echo "  - Workflow changes"
          fi
          if [[ "${{ needs.detect-strategy.outputs.critical }}" == "true" ]]; then
            echo "  - Critical configuration changes"
          fi